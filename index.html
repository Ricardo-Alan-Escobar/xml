<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clasificador CFDI</title>
  <link href="style.css" rel="stylesheet" />
</head>
<body>
  <h1>Importador y Clasificador CFDI</h1>

  <div class="box">
    <h3 style="margin-bottom: 50px;">Cargar XML</h3> 
    <label class="file-drop" for="xmlFiles">
      üìÇ Haz clic aqu√≠ o arrastra tus XML
      <input type="file" id="xmlFiles" multiple accept=".xml" />
    </label>
    <br>
    <button id="processBtn" style="margin-top: 50px;">Procesar XML</button>
  </div>

  <div class="box">
    <h3>Filtro por categor√≠a SAT</h3>
    <div class="custom-select">
      <div class="select-box" id="selectBox">Todas</div>

      <div class="select-dropdown" id="selectDropdown">
        <input type="text" id="selectSearch" class="dropdown-search" placeholder="Buscar categor√≠a...">
        <div id="selectOptions"></div>
      </div>
    </div>
 <button id="exportExcelBtn" style="margin-top:20px; background-color: green;">Exportar a Excel</button>

  </div>
  
  <div class="box">
    <h3>Resultados</h3>
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>ClaveProdServ</th>
          <th>Categor√≠a SAT</th>
          <th>Cantidad</th>
          <th>Importe</th>
          <th>Fecha</th>
          <th>Emisor</th>
          <th>Receptor</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>

<script>

const satCatalog = {
  "15101514": "Combustibles - Gasolina Regular",
  "15101515": "Combustibles - Gasolina Premium",
  "15101505": "Combustibles - Di√©sel",
  "15101513": "Combustibles - Di√©sel (Uso fuera de carretera)",
  "26101504": "Motores - Motor Di√©sel",
  "43212100": "Tecnolog√≠a - Computadoras",
  "44103103": "Tecnolog√≠a - Toner",
  "43222609": "Tecnolog√≠a - Impresoras",
  "43191501": "Tecnolog√≠a - Tel√©fonos",
  "72101500": "Servicios - Energ√≠a el√©ctrica",
  "72101600": "Servicios - Agua",
  "30101500": "Construcci√≥n - Materiales",
  "72141000": "Construcci√≥n - Maquinaria pesada",
  "46171610": "Tecnolog√≠a - C√°maras de Seguridad (CCTV)",
  "45121516": "Tecnolog√≠a - C√°maras Fotogr√°ficas",
  "46171621": "Tecnolog√≠a - DVR/NVR (Grabadores CCTV)",
  "52161505": "Tecnolog√≠a - Televisores",
  "43211902": "Tecnolog√≠a - Monitores",
  "43222612": "Redes - Switches",
  "43222609": "Redes - Routers",
  "43222610": "Redes - Access Points WiFi",
  "26121636": "Redes - Cable UTP",
  "26121608": "Electricidad - Cableado El√©ctrico",
  "43223307": "Redes - Patch Cords",
  "26121622": "Redes - Conectores RJ45",
  "43211501": "Tecnolog√≠a - Servidores",
  "43201803": "Tecnolog√≠a - Discos Duros",
  "43201802": "Tecnolog√≠a - SSD",
  "43202005": "Tecnolog√≠a - Memorias RAM",
  "43211708": "Tecnolog√≠a - Teclados",
  "43211707": "Tecnolog√≠a - Mouse",
  "43211612": "Tecnolog√≠a - Bocinas",
  "43211602": "Tecnolog√≠a - Proyectores",
  "46171619": "Seguridad - Biom√©tricos",
  "46171501": "Seguridad - Alarmas",
  "46171600": "Seguridad - Equipo Videovigilancia",
  "43231512": "Software - Antivirus",
  "43232406": "Software - Ofim√°tica",
  "43232902": "Software - Sistemas Operativos",
};

const xmlFileContents = [];
const results = [];


const selectBox = document.getElementById("selectBox");
const dropdown = document.getElementById("selectDropdown");
const searchInput = document.getElementById("selectSearch");
const optionsContainer = document.getElementById("selectOptions");

let selectedCategory = "";

function buildCategoryList() {
  const categories = ["Todas", ...new Set(Object.values(satCatalog))].sort();
  renderOptions(categories);
}

function renderOptions(list) {
  optionsContainer.innerHTML = "";
  
  list.forEach(cat => {
    const div = document.createElement("div");
    div.className = "option-item";
    div.textContent = cat;

    div.onclick = () => {
      selectedCategory = cat === "Todas" ? "" : cat;
      selectBox.textContent = cat;
      dropdown.style.display = "none";
      renderTable();
    };

    optionsContainer.appendChild(div);
  });
}

searchInput.addEventListener("input", () => {
  const term = searchInput.value.toLowerCase();
  const categories = ["Todas", ...new Set(Object.values(satCatalog))].sort();

  const filtered = categories.filter(c =>
    c.toLowerCase().includes(term)
  );

  renderOptions(filtered);
});

selectBox.addEventListener("click", () => {
  dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
});

buildCategoryList();


document.getElementById("xmlFiles").addEventListener("change", async (event) => {
  xmlFileContents.length = 0;
  const files = [...event.target.files];

  for (const file of files) {
    const text = await file.text();
    xmlFileContents.push(text);
  }
});

document.getElementById("processBtn").addEventListener("click", () => {
  results.length = 0;

  xmlFileContents.forEach(text => {
    const parser = new DOMParser();
    const xml = parser.parseFromString(text, "text/xml");

    const comp = xml.getElementsByTagName("cfdi:Comprobante")[0];
    if (!comp) return;

    const fecha = comp.getAttribute("Fecha") || "";
    const emisor = xml.getElementsByTagName("cfdi:Emisor")[0]?.getAttribute("Nombre") || "";
    const receptor = xml.getElementsByTagName("cfdi:Receptor")[0]?.getAttribute("Nombre") || "";

    const conceptos = xml.getElementsByTagName("cfdi:Concepto");

    for (let c of conceptos) {
      const desc = c.getAttribute("Descripcion") || "";
      const clave = c.getAttribute("ClaveProdServ") || "";
      const cant = c.getAttribute("Cantidad") || "0";
      const importe = c.getAttribute("Importe") || "0";

      const categoria = satCatalog[clave] || "SIN CLASIFICAR";

      results.push({ desc, clave, categoria, cant, importe, fecha, emisor, receptor });
    }
  });

  renderTable();
});


function renderTable() {
  const tbody = document.getElementById("resultsBody");

  tbody.innerHTML = "";

  results
    .filter(r => !selectedCategory || r.categoria === selectedCategory)
    .forEach(r => {
      tbody.innerHTML += `
        <tr>
          <td>${r.desc}</td>
          <td>${r.clave}</td>
          <td>${r.categoria}</td>
          <td>${r.cant}</td>
          <td>${r.importe}</td>
          <td>${r.fecha}</td>
          <td>${r.emisor}</td>
          <td>${r.receptor}</td>
        </tr>
      `;
    });
}
document.getElementById("exportExcelBtn").addEventListener("click", () => {
  if (results.length === 0) {
    alert("No hay datos para exportar. Por favor procesa algunos archivos XML primero.");
    return;
  }


  const dataToExport = results.filter(r => !selectedCategory || r.categoria === selectedCategory);

  if (dataToExport.length === 0) {
    alert("No hay datos en la categor√≠a seleccionada para exportar.");
    return;
  }

  const excelData = dataToExport.map(r => ({
    "Producto": r.desc,
    "ClaveProdServ": r.clave,
    "Categor√≠a SAT": r.categoria,
    "Cantidad": r.cant,
    "Importe": r.importe,
    "Fecha": r.fecha,
    "Emisor": r.emisor,
    "Receptor": r.receptor
  }));


  const ws = XLSX.utils.json_to_sheet(excelData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Conceptos CFDI");

  const colWidths = [
    { wch: 40 }, // Producto
    { wch: 15 }, // ClaveProdServ
    { wch: 35 }, // Categor√≠a SAT
    { wch: 10 }, // Cantidad
    { wch: 12 }, // Importe
    { wch: 20 }, // Fecha
    { wch: 30 }, // Emisor
    { wch: 30 }  // Receptor
  ];
  ws['!cols'] = colWidths;

  const fecha = new Date().toISOString().split('T')[0];
  const nombreArchivo = selectedCategory 
    ? `CFDI_${selectedCategory.replace(/[^a-z0-9]/gi, '_')}_${fecha}.xlsx`
    : `CFDI_Todos_${fecha}.xlsx`;

  XLSX.writeFile(wb, nombreArchivo);
});

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>
